---
title: "커뮤니티 기능 개발 - 공개적인 게시글 더 빨리 불러오기"
date: "2024-08-04"
description: "커뮤니티에는 어떤 가치가 최우선일까"
tags: [Til]
hashtags: [community, prefetch, post, comment]
# thumbnail: /thumbnails/hello-world.jpg
# order: 32
draft: true
---

### 커뮤니티 기능개발

개발전에 이 기능에 대해서는 어떤 가치가 제일 중요할지 고민했다.

커뮤니티는 사람들의 의견을 공유하는 공간으로

빠른 인터렉션이 중요하다고 생각했다.

### 개요

먼저 공개범위에 대한 설정이 계속 발전해가는 중이었어서 이것으로 api가 분리되었다.

가장먼저 설계의도는 비회원일때의 호출하는 것과 회원일때 호출하는것이 나뉘어졌다.

그리고 회원중에서의 나뉘는 것, 예를들면 비공개 게시글인데 자기 게시글이면 보여줘야하고 아니면 권한에러를 발생시키고 등은

백엔드에서 처리하게 되었다.

### 문제인식

우리 서비스에는 회원인증에 걸리는 시간이 존재했다.

모종의 이유로 타 서비스에 비해 압도적으로 오래걸렸는데.. 아직은 그 문제가 해결되지 않은 상태였다.

그렇기에 회원인증이 거친다음에 호출한다는 것은 꽤 많은 시간 사용자가 기다려야했음을 의미했다.

### 우회해결

문제라고 인식했던것은 공개적인 게시글에 대한 처리였다.

로그인을 했다는 이유로 공개적인 게시글에 대해서 받아오는 시간이 더 걸려야했다.

한글자도 다르지 않은 동일한 내용이었다.

더 서비스에 관심이 있는 사용자에게 시간을 많이 기다려야한다는게 불쾌하게 느낄거라 생각했다.

<br/>

여기서 다르게 생각해 본것은,

비회원에게는 공개적인 게시글을 인증없이 무조건적으로 보여줄테니,

만약에 공개적인 게시글이면 굳이 회원인증 후에 토큰이 필요한 api를 호출하지 않고

공개적인 api를 호출하여 빠르게 보여줘야겠다고 생각했다.

근데 호출전에는 이 게시글이 공개적인지 아닌지 알수 없으므로

우선 무조건 공개적인 게시글을 호출한 다음에, 인증 에러가 생기면

분기를 나누어

1. 로그인 사용자 -> 인증이 필요한 api로 재 호출

2. 비로그인 사용자 -> 권한이 없음을 보여준다.

이렇게 처리하였다.

### 확실히 빨라진 속도

인증과정을 기다리지 않아도되니,

공개적인 게시글에 한하여 속도가 아주 향상되었다.

### 예상치 못한 문제 발생

문제는 .. 공감 기능에서 발생했다.

게시글에는 공감기능이 함께 달려있었다.

이 공감은 사용자가 누르는 상호작용을 할 수 있었다.

이 공감 데이터는 게시글 데이터와 함께 전달되었다.

내부 데이터는 현재 몇개의 공감인지와 사용자가 눌렀는지 여부였다.

공개적인 게시글에 대해서 문제가 발생했다.

<br/>

### 눌러도 저장되지 않는 공감

공게적인 게시글에 대해서 인증이 필요하지 않는 api로 정보를 받아오다보니

공감이 눌렀는지 전달받는 데이터에 대해서는 무조건 false 값이 넘어왔다.

당연했다. 사용자를 구분할 수없으니 안눌렸다고 판단할 수 밖에

### 되돌리기..

결국 api 설계의도와 다르게 호출하다보니 이런문제가 발생하여

설계의도와 부합되게 수정하였다.

오래걸리는 인증절차 개선.. 이 본질적인 문제를 해결하는게 더 낫겟다 판단했다.

그리고 좀더 고민하여 prefatch를 적용하여 어느정도 속도개선을 이루었다.

- ssr

- 프리패치

- 스켈레톤x

- 댓글을 입력했을때는 캐시 삭제

- 캐시 리셋과 리패치의 차이

---

같은 쿼리키임에도, 중복요청이 되는것을 확인.

- 같은 쿼리키에 대해서 중복요청을 하지 않는것으로 알고 있었음

1차적으로 get 쿼리를 통해서 현재 캐시되어있는지 확인

그리고 없다면 prefetch 요청

그리고 댓글의 경우에는 0이 아닐경우만 요청

---

한번더 나아가서 리스트에서 보여주는 데이터와

상세데이터가 완벽하게 동일했으므로, 상세 데이터를 굳이 요청하지않고

상세데이터 요청과 똑같은 쿼리키로 리스트중 하나의 게시글 데이터를 set함

그래서 요청자체를 없애버림

그렇다면 상세페이지에 들어가는것은 게시글을 클릭해야가능하므로 상세페이지 api는 이제 필요없냐? x

링크를 통해서 바로 접속할경우나 상세페이지에서 새로고침할 경우를 대비해서 필요하다.

이 경우에도 스켈레톤을 최대한 안보여주기 위해서 ssr로직으로 1차 대응

---

눈속임

페이지네이션에서 프리패치 - 페이지 번호에 부여 / 마지막페이지에서 컴포넌트 사이에 - 오늘의집

---

조회수 측정

리스트에서 넘기듯이 본걸 조회했다고 할 수 있을까?

- 더보기버튼

- 공감

- 유튜브 커뮤니티의 감지 방식

---

이렇다보니까 공감을 마구 누르면 조회수가 마구 올라가는 현상 발생

이 현상을 방지하기 위해 조회수에 대한 저장이 필요하다.

db에 저장하게 되면 한번만 조회하고 그 이후에는 조회를 하지 못하는 현상이 발생한다.

서비스 초기단계에서는 강력한 규제는 피하되, 남용을 막을필요는 있어서

서버에 전달하는 것보다는 쿠키에 저장하는 것으로 선택했다.

30초의 제한시간을 둬서 해당 게시글과 마지막 상호작용이 일어난뒤 30초가 흐르고 다시 방문하면

조회수가 올라가도록 했다.
